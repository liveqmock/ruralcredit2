<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="FINANCEMONEY">
	<typeAlias alias="financeMoney" type="com.creditease.rc.domain.FinanceMoney" />
	<typeAlias alias="creditApplication" type="com.creditease.rc.domain.CreditApplication" />
	<typeAlias alias="receivedRecordVo" type="com.creditease.rc.vo.ReceivedRecordVo"></typeAlias>
	<typeAlias alias="accountInfo" type="com.creditease.rc.domain.AccountInfo" />
	<typeAlias alias="auditRemind" type="com.creditease.rc.vo.AuditRemindVo" />
	<resultMap id="financeMoneyResultMap" class="com.creditease.rc.domain.FinanceMoney">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->
		<result column="FINANCE_MONEY_ID" property="financeMoneyId" jdbcType="DECIMAL" />
		<result column="TYPE" property="type" jdbcType="VARCHAR" />
		<result column="ASSOCIATION_ID" property="associationId" jdbcType="DECIMAL" />
		<result column="PAY_WAY" property="payWay" jdbcType="VARCHAR" />
		<result column="FINANCE_STATUS" property="financeStatus" jdbcType="VARCHAR" />
		<result column="OPERATOR_ID" property="operatorId" jdbcType="VARCHAR" />
		<result column="OPERATOR_NAME" property="operatorName" jdbcType="VARCHAR" />
		<result column="OPERATE_DATE" property="operateDate" jdbcType="TIMESTAMP" />
		<result column="REMARK" property="remark" jdbcType="VARCHAR" />
		<result column="HISTORY_FLAG" property="historyFlag" jdbcType="VARCHAR" />
		<result column="BIZ_ID" property="bizId" jdbcType="VARCHAR" />
		<result column="SYSTEM_SOURCE_ID" property="systemSourceId" jdbcType="VARCHAR" />
		<result column="CHN_ID" property="chnId" jdbcType="VARCHAR" />
		<result column="OPEN_BANK_NAME" property="openBankName" jdbcType="VARCHAR" />
		<result column="PRODUCT_ID" property="productId" jdbcType="VARCHAR" />
		<result column="BANK_ID" property="bankId" jdbcType="VARCHAR" />
		<result column="ACCOUNT_FLAG" property="accountFlag" jdbcType="VARCHAR" />
		<result column="ACCOUNT_NO" property="accountNo" jdbcType="VARCHAR" />
		<result column="ACCOUNT_NAME" property="accountName" jdbcType="VARCHAR" />
		<result column="AMOUNT" property="amount" jdbcType="VARCHAR" />
		<result column="CARD_KIND" property="cardKind" jdbcType="VARCHAR" />
		<result column="ID_CARD" property="idCard" jdbcType="VARCHAR" />
		<result column="SPECIAL_ID" property="specialId" jdbcType="VARCHAR" />
		<result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
		<result column="TRADE_TIME" property="tradeTime" jdbcType="TIMESTAMP" />
		<result column="RESERVE_TIME" property="reserveTime" jdbcType="TIMESTAMP" />
		<result column="RETURN_MSG" property="returnMsg" jdbcType="VARCHAR" />
		<result column="RESERVE_ID" property="reserveId" jdbcType="VARCHAR" />
	</resultMap>
	
	
	<!-- icp回退 -->
	<update id="updateIcp" parameterClass="string">
	update rl_finance_money t set t.history_flag='T' where 
                        t.association_id=(select max(g.group_loan_regist_id) 
                        from rl_group_loan_regist g where g.creditapplication_id=1 and g.history_flag='T')
	</update>
	
	<select id="selectFinanceMoney" resultClass="financeMoney" parameterClass="financeMoney">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->
		SELECT
		F.TRADE_TIME tradeTime,
		F.FINANCE_MONEY_ID financeMoneyId,
		DECODE(F.PAY_WAY,'N','网银','D','划扣') payWay,
		F.BIZ_ID bizId,
		A.BANK_NAME
		openBankName,
		A.ACCOUNT_NAME accountName,
		A.ACCOUNT accountNo,
		R.RECEIVED_AMOUNT amount,
		F.RESERVE_TIME reserveTime,
		F.RETURN_MSG
		returnMsg,
		F.OPERATOR_NAME operatorName,
		F.OPERATE_DATE operateDate,
		F.REMARK remark,
		R.CREDITAPPLICATION_ID creditapplicationId,
		F.FINANCE_STATUS financeStatus
		FROM
		RL_RECEIVED_RECORD R
		LEFT JOIN RL_FINANCE_MONEY F ON
		R.RECEIVED_RECORD_ID=F.ASSOCIATION_ID
		LEFT JOIN RL_ACCOUNT_INFO A ON
		R.ACCOUNT_INFO_ID=A.ACCOUNT_INFO_ID
		WHERE (F.HISTORY_FLAG='F' OR
		F.HISTORY_FLAG IS NULL)
		<isNotEmpty property="associationId" prepend="and">
			R.RECEIVED_RECORD_ID = #associationId:DECIMAL#
    </isNotEmpty>
	</select>
	<select id="selectFinanceMoneyForFinanceMoneyBack" resultClass="financeMoney" parameterClass="financeMoney">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->
		SELECT
		F.TRADE_TIME tradeTime,
		F.FINANCE_MONEY_ID financeMoneyId,
		DECODE(F.PAY_WAY,'N','网银','D','划扣') payWay,
		F.BIZ_ID bizId,
		F.OPEN_BANK_NAME openBankName,
		F.ACCOUNT_NAME accountName,
		F.ACCOUNT_NO
		accountNo,
		F.AMOUNT amount,
		F.RESERVE_TIME reserveTime,
		F.RETURN_MSG
		returnMsg,
		F.OPERATOR_NAME operatorName,
		F.OPERATE_DATE operateDate,
		F.REMARK remark,
		A.CREDIT_APPLICATION_ID creditapplicationId,
		F.FINANCE_STATUS financeStatus
		FROM
		RL_FINANCE_MONEY F
		LEFT JOIN RL_AMOUNT_CONFIRM A ON
		F.ASSOCIATION_ID=A.AMOUNT_CONFIRM_ID
		WHERE (F.HISTORY_FLAG='F' OR
		F.HISTORY_FLAG IS NULL) AND F.TYPE='U'
		<isNotEmpty property="associationId" prepend="and">
			F.ASSOCIATION_ID = #associationId:DECIMAL#
    </isNotEmpty>
	</select>
	<select id="selectFinanceMoneyForFinanceMoneyBack2" resultClass="financeMoney" parameterClass="financeMoney">
		SELECT
		NULL tradeTime,
		'' financeMoneyId,
		'网银' payWay,
		'' bizId,
		AI.BRANCH_NAME openBankName,
		AI.ACCOUNT_NAME accountName,
		AI.ACCOUNT accountNo,
		A.REAL_AMOUNT amount,
		NULL reserveTime,
		'' returnMsg,
		'' operatorName,
		'' operateDate,
		'' remark,
		A.CREDIT_APPLICATION_ID creditapplicationId
		FROM RL_AMOUNT_CONFIRM A
		LEFT JOIN RL_CREDIT_APPLICATION C ON A.CREDIT_APPLICATION_ID=C.CREDITAPPLICATION_ID
		LEFT JOIN RL_ACCOUNT_INFO AI ON C.ACCOUNT_INFO_ID=AI.ACCOUNT_INFO_ID
		WHERE 1=1
		<isNotEmpty property="associationId" prepend="and">
			A.AMOUNT_CONFIRM_ID = #associationId:DECIMAL#
    </isNotEmpty>
	</select>
	<select id="selectReceiveFinanceMoney" resultClass="financeMoney" parameterClass="financeMoney">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->
		select FINANCE_MONEY_ID financeMoneyId,OPEN_BANK_NAME openBankName,
		ACCOUNT_NAME accountName, ACCOUNT_NO accountNo,AMOUNT amount,
		RESERVE_TIME reserveTime,RETURN_MSG returnMsg, OPERATOR_NAME
		operatorName,OPERATE_DATE operateDate, REMARK remark
		from
		RL_FINANCE_MONEY
		WHERE HISTORY_FLAG='F' AND TYPE='S'
		<isNotEmpty property="financeMoneyId" prepend="and">
			FINANCE_MONEY_ID = #financeMoneyId:DECIMAL#
    </isNotEmpty>
	</select>
	<select id="selectPaymentFinanceMoney" resultClass="financeMoney" parameterClass="creditApplication">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->
		SELECT
		F.FINANCE_MONEY_ID financeMoneyId,
		G.CREDITAPPLICATION_ID
		creditapplicationId,
		BANK_ID bankId,
		RETURN_MSG returnMsg,
		ACCOUNT_NO
		accountNo,
		ACCOUNT_NAME accountName,
		DECODE(PAY_WAY,'N','网银','D','划扣')
		payWay,
		AMOUNT amount,
		ASSOCIATION_ID associationId,
		RESERVE_TIME
		reserveTime,
		REMARK remark,
		BIZ_ID bizId,
		F.REMARK remark,
		F.FINANCE_STATUS financeStatus,
		F.TRADE_TIME tradeTime
		FROM
		RL_FINANCE_MONEY F
		LEFT JOIN RL_GROUP_LOAN_REGIST G ON
		G.GROUP_LOAN_REGIST_ID=F.ASSOCIATION_ID
		WHERE F.HISTORY_FLAG='F' AND
		F.TYPE='F'
		<isNotEmpty property="creditapplicationId" prepend="and">
			g.creditapplication_id = #creditapplicationId:DECIMAL#
   </isNotEmpty>
	</select>
	<select id="selectPaymentFinanceMoneyFromAmountTable" resultClass="financeMoney" parameterClass="creditApplication">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->
		SELECT
		f.FINANCE_MONEY_ID financeMoneyId,
		A.CREDIT_APPLICATION_ID
		creditapplicationId,
		BANK_ID bankId,
		RETURN_MSG returnMsg,
		ACCOUNT_NO
		accountNo,
		ACCOUNT_NAME accountName,
		DECODE(PAY_WAY,'N','网银','D','划扣')
		payWay,
		F.AMOUNT amount,
		ASSOCIATION_ID associationId,
		RESERVE_TIME
		reserveTime,
		REMARK remark,
		BIZ_ID bizId,
		F.FINANCE_STATUS auditStatus,
		F.FINANCE_STATUS financeStatus,
		F.TRADE_TIME tradeTime
		FROM RL_FINANCE_MONEY f
		LEFT JOIN
		RL_AMOUNT_CONFIRM A on A.AMOUNT_CONFIRM_ID=f.association_id
		WHERE
		f.HISTORY_FLAG='F' AND f.TYPE='F' AND A.HISTORY_FLAG='0'
		<isNotEmpty property="creditapplicationId" prepend="and">
			A.CREDIT_APPLICATION_ID = #creditapplicationId:DECIMAL#
   </isNotEmpty>
	</select>
	<select id="selectPaymentFinanceMoneyList" resultClass="financeMoney" parameterClass="financeMoney">
		select f.FINANCE_MONEY_ID financeMoneyId,
		f.FINANCE_STATUS financeStatus,
		g.CREDITAPPLICATION_ID creditapplicationId,
		g.CREDITAPPLICATION_ID associationId,
		f.TYPE type,
		f.account_no accountNo,
		f.account_name accountName,
		f.history_flag as historyFlag,
		f.biz_id as bizId,
		f.return_msg returnMsg,
		f.remark as remark,
	    f.operator_id as operatorId,
	    f.operator_name as operatorName,
	    f.operate_date as  operateDate,
		f.amount amount
		from RL_FINANCE_MONEY f, RL_GROUP_LOAN_REGIST g
		where g.GROUP_LOAN_REGIST_ID = f.association_id
		<isNotEmpty property="bizId" prepend="and">
			BIZ_ID=#bizId#
		</isNotEmpty>
	</select>
	<select id="selectPaymentFinanceMoneyListFromAmountTable" resultClass="financeMoney" parameterClass="financeMoney">
		select f.FINANCE_MONEY_ID financeMoneyId,
		f.FINANCE_STATUS financeStatus,
		A.CREDIT_APPLICATION_ID creditapplicationId,
		A.CREDIT_APPLICATION_ID associationId,
		F.TYPE type,
		f.account_no accountNo,
		f.account_name accountName,
		f.amount amount
		FROM RL_FINANCE_MONEY
		F, RL_AMOUNT_CONFIRM A
		WHERE A.AMOUNT_CONFIRM_ID=F.ASSOCIATION_ID
		<isNotEmpty property="bizId" prepend="and">
			BIZ_ID=#bizId#
		</isNotEmpty>
	</select>
	<select id="selectReceiveFinanceMoneyList" resultClass="financeMoney" parameterClass="financeMoney">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->

		SELECT
		F.FINANCE_STATUS financeStatus,
		R.RECEIVED_RECORD_ID
		associationId,
		R.CREDITAPPLICATION_ID creditapplicationId,
		F.TYPE type
		FROM RL_FINANCE_MONEY F,RL_RECEIVED_RECORD R
		WHERE
		F.ASSOCIATION_ID=R.RECEIVED_RECORD_ID
		AND F.HISTORY_FLAG='F'
		<isNotEmpty property="bizId" prepend="and">
			F.BIZ_ID=#bizId#
   		</isNotEmpty>
		UNION
		SELECT
		F.FINANCE_STATUS financeStatus,
		A.AMOUNT_CONFIRM_ID
		associationId,
		A.CREDIT_APPLICATION_ID creditapplicationId,
		F.TYPE type
		FROM RL_FINANCE_MONEY F,RL_AMOUNT_CONFIRM A,RL_CREDIT_APPLICATION C
		WHERE F.ASSOCIATION_ID=A.AMOUNT_CONFIRM_ID
		AND
		A.CREDIT_APPLICATION_ID=C.CREDITAPPLICATION_ID
		AND F.TYPE='U'AND
		A.HISTORY_FLAG='0' AND F.HISTORY_FLAG='F'
		<isNotEmpty property="bizId" prepend="and">
			F.BIZ_ID=#bizId#
  		</isNotEmpty>
	</select>
	<select id="selectFinanceMoneyListByBizId" resultClass="financeMoney" parameterClass="String">
		<!-- WARNING - This element is automatically generated by Abator for iBATIS, do not modify. -->
		SELECT R.CREDITAPPLICATION_ID creditapplicationId,
		F.BIZ_ID bizId,
		F.ASSOCIATION_ID associationId,
		F.TYPE type,
		F.FINANCE_STATUS financeStatus
		FROM RL_FINANCE_MONEY F
		LEFT JOIN RL_RECEIVED_RECORD R ON F.ASSOCIATION_ID=R.RECEIVED_RECORD_ID
		WHERE F.BIZ_ID=#value#
	</select>
	<!-- 郝强用 -->
	<select id="selectCountReceiveFinanceMoneyList" resultClass="Integer" parameterClass="financeMoney">
		select count(f.ASSOCIATION_ID)
		from RL_FINANCE_MONEY
		f,RL_RECEIVED_RECORD r
		where f.ASSOCIATION_ID=r.RECEIVED_RECORD_ID
		<isNotEmpty property="bizId" prepend="and">
			BIZ_ID=#bizId#
		</isNotEmpty>
	</select>

	<insert id="insertFinanceMoney" parameterClass="financeMoney">
		<selectKey keyProperty="financeMoneyId" resultClass="int" type="pre">
			select SEQ_BASIC_INFO.NEXTVAL as value from dual
	</selectKey>
		insert into RL_FINANCE_MONEY (FINANCE_MONEY_ID, TYPE, ASSOCIATION_ID,
		PAY_WAY, FINANCE_STATUS,
		OPERATOR_ID, OPERATOR_NAME, OPERATE_DATE,
		REMARK, HISTORY_FLAG, BIZ_ID,
		SYSTEM_SOURCE_ID,
		CHN_ID, OPEN_BANK_NAME,
		PRODUCT_ID, BANK_ID, ACCOUNT_FLAG, ACCOUNT_NO,
		ACCOUNT_NAME, AMOUNT,
		CARD_KIND, ID_CARD, SPECIAL_ID, MOBILE,
		TRADE_TIME,RETURN_MSG,RESERVE_TIME,
		RESERVE_ID)
		values (#financeMoneyId:DECIMAL#,
		#type:VARCHAR#,
		#associationId:DECIMAL#, #payWay:VARCHAR#,
		#financeStatus:VARCHAR#, #operatorId:VARCHAR#, #operatorName:VARCHAR#,
		#operateDate:TIMESTAMP#, #remark:VARCHAR#, #historyFlag:VARCHAR#,
		#bizId:VARCHAR#,
		#systemSourceId:VARCHAR#, #chnId:VARCHAR#,
		#openBankName:VARCHAR#, #productId:VARCHAR#,
		#bankId:VARCHAR#,
		#accountFlag:VARCHAR#, #accountNo:VARCHAR#,
		#accountName:VARCHAR#,
		#amount:VARCHAR#, #cardKind:VARCHAR#, #idCard:VARCHAR#,
		#specialId:VARCHAR#,
		#mobile:VARCHAR#,
		#tradeTime:TIMESTAMP#,
		#returnMsg:VARCHAR#,#reserveTime:TIMESTAMP#,
		#reserveId:VARCHAR#)
	</insert>
	<update id="updateFinanceMoney" parameterClass="financeMoney">
		UPDATE
		RL_FINANCE_MONEY
		SET HISTORY_FLAG='T'
		WHERE ASSOCIATION_ID =
		#associationId# AND
		TYPE!='F'
  	</update>
  	<update id="updateFinanceMoneyTYPEisF" parameterClass="financeMoney">
		UPDATE
		RL_FINANCE_MONEY
		SET HISTORY_FLAG='T'
		WHERE ASSOCIATION_ID =
		#associationId#
  	</update>
	<update id="updateFinanceMoneyPayment" parameterClass="financeMoney">
		UPDATE
		RL_FINANCE_MONEY
		SET HISTORY_FLAG='T'
		WHERE ASSOCIATION_ID =
		#associationId# AND
		TYPE='F'
  	</update>
	<select id="getBizId" resultClass="Long">
		select PAY_PLATFORM_SEQ.NEXTVAL
		as value from dual
  </select>
	<update id="updateFinanceMoneyStatus" parameterClass="financeMoney">
		UPDATE RL_FINANCE_MONEY
		<dynamic prepend="SET">
			<isNotEmpty property="financeStatus" prepend=",">
				FINANCE_STATUS=#financeStatus# 
		  	</isNotEmpty>
			<isNotEmpty property="returnMsg" prepend=",">
				RETURN_MSG=#returnMsg#
		  	</isNotEmpty>
			<isNotEmpty property="operateDate" prepend=",">
				OPERATE_DATE=#operateDate#
		  	</isNotEmpty>
			<isNotEmpty property="tradeTime" prepend=",">
				TRADE_TIME=#tradeTime#
		  	</isNotEmpty>
			<isNotEmpty property="amount" prepend=",">
				AMOUNT=#amount#
			</isNotEmpty>
		</dynamic>
		WHERE HISTORY_FLAG='F'
		<isEqual property="type" prepend="AND" compareValue='S'>
			(TYPE='S' OR TYPE='U')
		</isEqual>
		<isEqual property="type" prepend="AND" compareValue='F'>
			TYPE='F'
		</isEqual>
		AND BIZ_ID=#bizId#
	</update>
	<sql id="receiveListBak">
		<!-- 这段SQL比较复杂。用了两个Union，共3个select。 第一个select是查正常收款预约的， 第二个select是查财务表里已经有的财务回收记录（只有预约过后，财务表里才有记录） 第三个select是查财务表里没有的财务回收记录（如果刚做放款登记，财务表里是没有的） -->
		select distinct
		r.received_record_id creditapplicationId,
		c.BUSINESS_NUMBER
		groupNumber,
		b.NAME groupName,
		a.AMOUNT groupAppTotal,
		c.signagreement_date signagreementDate,
		c.loan_officer_name
		loanOfficerName,
		nvl2(f.finance_status,f.finance_status,'0')
		operateStatus,
		decode(f.finance_status,null,'未预约',0,'未预约',1,'已预约',2,'收款成功',3,'收款失败',4,'撤销',5,'作废'
		) loansStatus,
		decode(r.RECEIVED_TYPE,0,'正常收款登记',1,'提前还款登记',2,'逾期还款登记
		') receivedType,
		r.received_amount realAmount,
		f.biz_id bizId,
		decode(r.capital_source,'C','现金','R','客户汇款','A','个人卡划扣') capitalSource,
		r.RECEIVED_TIME operateDate,
		nvl2(f.finance_status,f.finance_status,'0') operateFlag,
		decode(c.business_type,'0','分公司','1','个人') businessType
		from
		rl_received_record r left join rl_finance_money f on
		f.association_id=r.received_record_id
		left join rl_credit_application c
		on
		r.creditapplication_id=c.creditapplication_id
		left join
		rl_amount_confirm a on
		c.creditapplication_id=a.credit_application_id
		left join rl_borrower_service_app b on
		c.creditapplication_id=b.creditapplication_id
		and b.valid_state = '1' and b.leader = '1'
		,sid_view v
		where
		r.history_flag='F' and a.history_flag='0' and (f.history_flag='F'OR
		F.HISTORY_FLAG IS NULL)
		<isNotEmpty prepend="AND" property="authList">
			c.creditapplication_id =
			v.object_id_identity
			        </isNotEmpty>
		<isNotEmpty prepend="AND" property="authList">
			v.class='com.creditease.rc.domain.CreditApplication'
			        </isNotEmpty>
		<isNotEmpty prepend="AND" property="authList">
			v.ace_sid IN
			($authList$)
			        </isNotEmpty>
		<isNotEmpty property="loansStatus" prepend="and">
			<isEqual property="loansStatus" compareValue="0">
				f.finance_status is null
      		</isEqual>
			<isNotEqual property="loansStatus" compareValue="0">
				f.finance_status=#loansStatus#
      		</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="receivedType" prepend="and">
			r.RECEIVED_TYPE=#receivedType#
			      	</isNotEmpty>
		<isNotEmpty property="capitalSource" prepend="and">
			r.capital_source=#capitalSource#
			      	</isNotEmpty>
		<isNotEmpty property="groupNumber" prepend="and">
			c.BUSINESS_NUMBER LIKE '%$groupNumber$%'
			      	</isNotEmpty>
        <isNotEmpty property="companyId" prepend="and">
            c.COMPANY_ID in ($companyId$)
        </isNotEmpty>
		<isNotEmpty property="beginLoanDate" prepend="and">
			c.signagreement_date>=#beginLoanDate#
			      	</isNotEmpty>
		<isNotEmpty property="endLoanDate" prepend="and">
			c.signagreement_date&lt;=#endLoanDate#
				      	</isNotEmpty>
		<isNotEmpty property="bizId" prepend="and">
			(f.BIZ_ID=#bizId# or f.RESERVE_ID=#bizId#)
		</isNotEmpty>
		<isNotEmpty property="businessType" prepend="and">
			C.BUSINESS_TYPE=#businessType#
		</isNotEmpty>
		<isNotEmpty property="fuzzyValue" prepend="AND">
			(C.BUSINESS_NUMBER like '%$fuzzyValue$%'
			or b.name like
			'%$fuzzyValue$%'
			or C.ADDRESS like '%$fuzzyValue$%'
			or C.AUDIT_STATUS
			like '%$fuzzyValue$%'
			or C.CONTACT_NUMBER like '%$fuzzyValue$%'
			or
			C.LOAN_OFFICER_NAME like '%$fuzzyValue$%')
        </isNotEmpty>
		<isNotEmpty prepend="AND" property="rw">
			f.finance_status is null
        </isNotEmpty>
		<isNotEmpty prepend="AND" property="rf">
			f.finance_status='3'
        </isNotEmpty>
		<!-- <isEqual prepend="AND" property="role" compareValue="rw"> f.finance_status is null </isEqual> <isEqual prepend="AND" property="role" compareValue="rf"> f.finance_status='3' </isEqual> -->
		<isEmpty property="receivedType">
			<isEmpty property="capitalSource">
				<isEmpty property="rw"><!-- 如果rw有值，则是要查未预约的，相应的就不查预约失败的 -->
					<!-- <isEqual property="role" compareValue="rf">财务收款失败提醒条件 -->
					UNION
					SELECT DISTINCT
					A.AMOUNT_CONFIRM_ID creditapplicationId,
					C.BUSINESS_NUMBER groupNumber,
					b.NAME groupName,
					A.AMOUNT groupAppTotal,
					C.SIGNAGREEMENT_DATE signagreementDate,
					C.LOAN_OFFICER_NAME loanOfficerName,
					NVL2(F.FINANCE_STATUS,F.FINANCE_STATUS,'0') operateStatus,
					DECODE(F.FINANCE_STATUS,null,'未预约',0,'未预约',1,'已预约',2,'收款成功',3,'收款失败',4,'撤销',5,'作废') loansStatus,
					'付款回收' receivedType,
					A.REAL_AMOUNT realAmount,
					F.BIZ_ID bizId,
					'付款回收' capitalSource,
					NULL operateDate,
					NVL2(F.FINANCE_STATUS,F.FINANCE_STATUS,'0') operateFlag,
					decode(c.business_type,'0','分公司','1','个人') businessType
					FROM
					RL_CREDIT_APPLICATION C
					LEFT JOIN RL_AMOUNT_CONFIRM A ON
					A.CREDIT_APPLICATION_ID =
					C.CREDITAPPLICATION_ID
					LEFT JOIN
					RL_FINANCE_MONEY F ON
					A.AMOUNT_CONFIRM_ID=F.ASSOCIATION_ID
					LEFT JOIN RL_BORROWER_SERVICE_APP B ON C.CREDITAPPLICATION_ID=B.CREDITAPPLICATION_ID
					AND B.VALID_STATE = '1' AND B.LEADER = '1'
					,SID_VIEW V
					WHERE C.AUDIT_STATUS='06' AND C.BUSINESS_TYPE='0' AND F.TYPE='U'AND
					A.HISTORY_FLAG='0'
					AND (F.HISTORY_FLAG='F'OR
					F.HISTORY_FLAG IS NULL)
					<isNotEmpty prepend="AND" property="authList">
						C.CREDITAPPLICATION_ID = V.OBJECT_ID_IDENTITY
			        </isNotEmpty>
					<isNotEmpty prepend="AND" property="authList">
						V.CLASS='com.creditease.rc.domain.CreditApplication'
			        </isNotEmpty>
					<isNotEmpty prepend="AND" property="authList">
						V.ACE_SID IN
						($authList$)
			        </isNotEmpty>
					<isNotEmpty property="loansStatus" prepend="and">
						F.FINANCE_STATUS=#loansStatus#
			      	</isNotEmpty>
					<isNotEmpty property="groupNumber" prepend="and">
						C.BUSINESS_NUMBER LIKE '%$groupNumber$%'
			      	</isNotEmpty>
                    <isNotEmpty property="companyId" prepend="and">
                        C.COMPANY_ID in ($companyId$)
                    </isNotEmpty>
					<isNotEmpty property="beginLoanDate" prepend="and">
						C.SIGNAGREEMENT_DATE>=#beginLoanDate#
			      	</isNotEmpty>
					<isNotEmpty property="endLoanDate" prepend="and">
						C.SIGNAGREEMENT_DATE&lt;=#endLoanDate#
				      	</isNotEmpty>
					<isNotEmpty property="bizId" prepend="and">
						F.BIZ_ID=#bizId#
				</isNotEmpty>
					<isNotEmpty property="businessType" prepend="and">
						C.BUSINESS_TYPE=#businessType#
				</isNotEmpty>
					<isNotEmpty property="fuzzyValue" prepend="AND">
						(C.BUSINESS_NUMBER like '%$fuzzyValue$%'
						or b.name like
						'%$fuzzyValue$%'
						or C.ADDRESS like '%$fuzzyValue$%'
						or C.AUDIT_STATUS
						like '%$fuzzyValue$%'
						or C.CONTACT_NUMBER like '%$fuzzyValue$%'
						or
						C.LOAN_OFFICER_NAME like '%$fuzzyValue$%')
	            </isNotEmpty>
					<isNotEmpty prepend="and" property="rf">
						F.FINANCE_STATUS='3'
	            </isNotEmpty>
					<!-- </isEqual> -->
				</isEmpty>
				<isEmpty property="bizId">
					<isEmpty property="loansStatus">
						<isEmpty property="rf"> <!-- 如果要查预约失败的，刚不查未预约的 -->
							<!--<isEqual property="role" compareValue="rw"> 财务未收款提醒条件 -->
							UNION
							SELECT DISTINCT
							A.AMOUNT_CONFIRM_ID creditapplicationId,
							C.BUSINESS_NUMBER groupNumber,
							b.NAME groupName,
							A.AMOUNT groupAppTotal,
							C.SIGNAGREEMENT_DATE signagreementDate,
							C.LOAN_OFFICER_NAME loanOfficerName,
							'0' operateStatus,
							'未预约' loansStatus,
							'付款回收' receivedType,
							A.REAL_AMOUNT realAmount,
							'' bizId,
							'付款回收' capitalSource,
							NULL operateDate,
							'0' operateFlag,
							decode(c.business_type,'0','分公司','1','个人') businessType
							FROM RL_CREDIT_APPLICATION C
							LEFT JOIN RL_AMOUNT_CONFIRM A ON C.CREDITAPPLICATION_ID=A.CREDIT_APPLICATION_ID
							LEFT JOIN RL_BORROWER_SERVICE_APP B ON C.CREDITAPPLICATION_ID=B.CREDITAPPLICATION_ID
							AND B.VALID_STATE = '1' AND B.LEADER = '1'
							,SID_VIEW V
							WHERE C.AUDIT_STATUS='06' AND C.BUSINESS_TYPE='0' AND A.HISTORY_FLAG='0'
							AND A.AMOUNT_CONFIRM_ID NOT IN(
							SELECT DISTINCT A.AMOUNT_CONFIRM_ID FROM RL_CREDIT_APPLICATION C
							LEFT JOIN RL_AMOUNT_CONFIRM A ON C.CREDITAPPLICATION_ID=A.CREDIT_APPLICATION_ID
							LEFT JOIN RL_FINANCE_MONEY F ON A.AMOUNT_CONFIRM_ID=F.ASSOCIATION_ID,SID_VIEW V
							WHERE
							C.AUDIT_STATUS='06' AND C.BUSINESS_TYPE='0'
							AND A.HISTORY_FLAG='0'AND (F.HISTORY_FLAG='F'OR F.HISTORY_FLAG IS NULL)
							AND (F.TYPE='U' OR F.TYPE IS NULL)
							<isNotEmpty prepend="AND" property="authList">
								C.CREDITAPPLICATION_ID = V.OBJECT_ID_IDENTITY
			        </isNotEmpty>
							<isNotEmpty prepend="AND" property="authList">
								V.CLASS='com.creditease.rc.domain.CreditApplication'
				        </isNotEmpty>
							<isNotEmpty prepend="AND" property="authList">
								V.ACE_SID IN
								($authList$)
				        </isNotEmpty>
							<isNotEmpty property="loansStatus" prepend="and">
								F.FINANCE_STATUS=#loansStatus#
				      	</isNotEmpty>
							<isNotEmpty property="groupNumber" prepend="and">
								C.BUSINESS_NUMBER LIKE '%$groupNumber$%'
				      	</isNotEmpty>
                            <isNotEmpty property="companyId" prepend="and">
                                C.COMPANY_ID in ($companyId$)
                            </isNotEmpty>
							<isNotEmpty property="beginLoanDate" prepend="and">
								C.SIGNAGREEMENT_DATE>=#beginLoanDate#
				      	</isNotEmpty>
							<isNotEmpty property="endLoanDate" prepend="and">
								C.SIGNAGREEMENT_DATE&lt;=#endLoanDate#
					      	</isNotEmpty>
							<isNotEmpty property="bizId" prepend="and">
								F.BIZ_ID=#bizId#
					</isNotEmpty>
							<isNotEmpty property="businessType" prepend="and">
								C.BUSINESS_TYPE=#businessType#
					</isNotEmpty>
							<isNotEmpty property="fuzzyValue" prepend="AND">
								(C.BUSINESS_NUMBER like '%$fuzzyValue$%'
								or b.name like
								'%$fuzzyValue$%'
								or C.ADDRESS like '%$fuzzyValue$%'
								or C.AUDIT_STATUS
								like '%$fuzzyValue$%'
								or C.CONTACT_NUMBER like '%$fuzzyValue$%'
								or
								C.LOAN_OFFICER_NAME like '%$fuzzyValue$%')
			           </isNotEmpty>

							)
							<isNotEmpty prepend="AND" property="authList">
								C.CREDITAPPLICATION_ID = V.OBJECT_ID_IDENTITY
		        </isNotEmpty>
							<isNotEmpty prepend="AND" property="authList">
								V.CLASS='com.creditease.rc.domain.CreditApplication'
			        </isNotEmpty>
							<isNotEmpty prepend="AND" property="authList">
								V.ACE_SID IN
								($authList$)
		        </isNotEmpty>
							<isNotEmpty property="groupNumber" prepend="and">
								C.BUSINESS_NUMBER LIKE '%$groupNumber$%'
		      	</isNotEmpty>
                            <isNotEmpty property="companyId" prepend="and">
                                C.COMPANY_ID in ($companyId$)
                            </isNotEmpty>
							<isNotEmpty property="beginLoanDate" prepend="and">
								C.SIGNAGREEMENT_DATE>=#beginLoanDate#
		      	</isNotEmpty>
							<isNotEmpty property="endLoanDate" prepend="and">
								C.SIGNAGREEMENT_DATE&lt;=#endLoanDate#
		      	</isNotEmpty>
							<isNotEmpty property="businessType" prepend="and">
								C.BUSINESS_TYPE=#businessType#
				</isNotEmpty>
							<isNotEmpty property="fuzzyValue" prepend="AND">
								(C.BUSINESS_NUMBER like '%$fuzzyValue$%'
								or b.name like
								'%$fuzzyValue$%'
								or C.ADDRESS like '%$fuzzyValue$%'
								or C.AUDIT_STATUS
								like '%$fuzzyValue$%'
								or C.CONTACT_NUMBER like '%$fuzzyValue$%'
								or
								C.LOAN_OFFICER_NAME like '%$fuzzyValue$%')
		           </isNotEmpty>
							<!-- </isEqual> -->
						</isEmpty>
					</isEmpty>
				</isEmpty>
			</isEmpty>
		</isEmpty>
		ORDER BY creditapplicationId DESC
	</sql>
	<sql id="backsection">
		<!-- 只查付款回收的sql -->
		SELECT DISTINCT
		A.AMOUNT_CONFIRM_ID creditapplicationId,
		C.BUSINESS_NUMBER groupNumber,
		b.NAME groupName,
		A.AMOUNT groupAppTotal,
		C.SIGNAGREEMENT_DATE signagreementDate,
		C.LOAN_OFFICER_NAME loanOfficerName,
		NVL2(F.FINANCE_STATUS,F.FINANCE_STATUS,'0') operateStatus,
		DECODE(F.FINANCE_STATUS,null,'未预约',0,'未预约',1,'已预约',2,'付款成功',3,'付款失败',4,'撤销',5,'作废') loansStatus,
		'付款回收' receivedType,
		A.REAL_AMOUNT realAmount,
		F.BIZ_ID bizId,
		'付款回收' capitalSource,
		NULL operateDate,
		NVL2(F.FINANCE_STATUS,F.FINANCE_STATUS,'0') operateFlag,
		decode(c.business_type,'0','分公司','1','个人') businessType
		FROM
		RL_CREDIT_APPLICATION C
		LEFT JOIN RL_AMOUNT_CONFIRM A ON
		A.CREDIT_APPLICATION_ID =
		C.CREDITAPPLICATION_ID
		LEFT JOIN
		RL_FINANCE_MONEY F ON
		A.AMOUNT_CONFIRM_ID=F.ASSOCIATION_ID
		LEFT JOIN RL_BORROWER_SERVICE_APP B ON C.CREDITAPPLICATION_ID=B.CREDITAPPLICATION_ID
		AND B.VALID_STATE = '1' AND B.LEADER = '1'
		,SID_VIEW V
		WHERE C.AUDIT_STATUS='06' AND C.BUSINESS_TYPE='0' AND (F.TYPE='F' OR F.TYPE IS NULL OR F.TYPE='U') AND
		A.HISTORY_FLAG='0'
		AND
		(F.HISTORY_FLAG='F'OR F.HISTORY_FLAG IS NULL)
		<isNotEmpty prepend="AND" property="authList">
			C.CREDITAPPLICATION_ID = V.OBJECT_ID_IDENTITY
		        </isNotEmpty>
		<isNotEmpty prepend="AND" property="authList">
			V.CLASS='com.creditease.rc.domain.CreditApplication'
		        </isNotEmpty>
		<isNotEmpty prepend="AND" property="authList">
			V.ACE_SID IN ($authList$)
		        </isNotEmpty>
		<isNotEmpty property="loansStatus" prepend="and">
			<isEqual property="loansStatus" compareValue="0">
				F.FINANCE_STATUS IS NULL
					</isEqual>
			<isNotEqual property="loansStatus" compareValue="0">
				F.FINANCE_STATUS=#loansStatus#
					</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="groupNumber" prepend="and">
			C.BUSINESS_NUMBER LIKE '%$groupNumber$%'
		      	</isNotEmpty>
        <isNotEmpty property="companyId" prepend="and">
            C.COMPANY_ID in ($companyId$)
        </isNotEmpty>
		<isNotEmpty property="beginLoanDate" prepend="and">
			C.SIGNAGREEMENT_DATE>=#beginLoanDate#
		      	</isNotEmpty>
		<isNotEmpty property="endLoanDate" prepend="and">
			C.SIGNAGREEMENT_DATE&lt;=#endLoanDate#
		      	</isNotEmpty>
		<isNotEmpty property="bizId" prepend="and">
			(f.BIZ_ID=#bizId# or f.RESERVE_ID=#bizId#)
				</isNotEmpty>
		<isNotEmpty property="businessType" prepend="and">
			C.BUSINESS_TYPE=#businessType#
				</isNotEmpty>
		<isNotEmpty property="fuzzyValue" prepend="AND">
			(C.BUSINESS_NUMBER like '%$fuzzyValue$%'
			or b.name like
			'%$fuzzyValue$%'
			or C.ADDRESS like '%$fuzzyValue$%'
			or C.AUDIT_STATUS
			like '%$fuzzyValue$%'
			or C.CONTACT_NUMBER like '%$fuzzyValue$%'
			or
			C.LOAN_OFFICER_NAME like '%$fuzzyValue$%')
	            </isNotEmpty>
		ORDER BY creditapplicationId DESC
	</sql>
	<select id="selectBackSectionList" parameterClass="creditApplication" resultClass="creditApplication">
		<include refid="backsection" />
	</select>
	<select id="selectCountBackSectionList" parameterClass="creditApplication" resultClass="Integer">
		SELECT COUNT(*) FROM (
		<include refid="backsection" />
		)
	</select>
	<select id="selectReceiveList" parameterClass="creditApplication" resultClass="creditApplication">
		<include refid="receiveListBak" />
	</select>
	<select id="selectCountReceiveList" parameterClass="creditApplication" resultClass="Integer">
		select count(*) from (
		<include refid="receiveListBak" />
		)
	</select>
	<select id="selectReceiveListHQ" parameterClass="creditApplication" resultClass="creditApplication">

		select * from(
		(
		<include refid="receiveListBak" />
		))
		a where a.creditapplicationId not in(select b.creditapplicationId from (
		<include refid="backsection" />
		) b)
	</select>
	<select id="selectCountReceiveListHQ" parameterClass="creditApplication" resultClass="Integer">
		select count(*) from (
		select * from(
		(
		<include refid="receiveListBak" />
		))
		a where a.creditapplicationId not in(select b.creditapplicationId from (
		<include refid="backsection" />
		) b)
		)
	</select>
	<select id="selectFinanceReceiveRemind" parameterClass="creditApplication" resultClass="auditRemind">
		SELECT operateStatus auditStatus,count(operateStatus) auditCount
		FROM (
		<include refid="receiveListBak" />
		) WHERE (operateStatus = '3' OR operateStatus = '0') group by operateStatus
	</select>
	<select id="selectOnline" resultClass="financeMoney" parameterClass="List">
		SELECT
		FINANCE_MONEY_ID financeMoneyId,
		BIZ_ID bizId
		FROM
		RL_FINANCE_MONEY
		WHERE HISTORY_FLAG='F' AND TYPE='S' AND FINANCE_STATUS
		IN ('0','1','3') AND
		ASSOCIATION_ID IN
		<iterate open="(" close=")" conjunction=",">
			#receivedRecordIdList[]#
		</iterate>
	</select>
	<!-- 以下为财务收款sql -->
	<select id="selectAccountInfo" parameterClass="Integer" resultMap="ACCOUNTINFO.accountInfoMap">
		select a.* from rl_account_info a
		left join
		RL_RECEIVED_RECORD r
		on a.ACCOUNT_INFO_ID=r.ACCOUNT_INFO_ID
		where
		r.RECEIVED_RECORD_ID=#value#
  </select>
	<select id="selectAccountInfoForFinanceBack" parameterClass="Integer" resultMap="ACCOUNTINFO.accountInfoMap">
		SELECT
		AI.*
		FROM RL_ACCOUNT_INFO AI
		LEFT JOIN
		RL_CREDIT_APPLICATION CA ON AI.ACCOUNT_INFO_ID =
		CA.ACCOUNT_INFO_ID
		LEFT JOIN RL_AMOUNT_CONFIRM AC ON
		AC.CREDIT_APPLICATION_ID=CA.CREDITAPPLICATION_ID
		WHERE
		AC.AMOUNT_CONFIRM_ID=#value#
  </select>
	<select id="selectReceiveRecordList" parameterClass="List" resultClass="receivedRecordVo">
		SELECT
		R.RECEIVED_RECORD_ID receivedRecordId,
		R.RECEIVED_AMOUNT
		receivedAmount,
		C.BORROWER_NAME borrowerName
		FROM RL_RECEIVED_RECORD R
		LEFT JOIN RL_CREDIT_APPLICATION C ON
		R.CREDITAPPLICATION_ID=C.CREDITAPPLICATION_ID
		WHERE
		R.RECEIVED_RECORD_ID IN
		<iterate open="(" close=")" conjunction=",">
			#receivedRecordId[]#
		</iterate>
		UNION
		SELECT
		A.AMOUNT_CONFIRM_ID creditapplicationId,
		A.REAL_AMOUNT receivedAmount,
		C.BORROWER_NAME borrowerName
		FROM
		RL_AMOUNT_CONFIRM A,RL_CREDIT_APPLICATION C
		WHERE
		A.CREDIT_APPLICATION_ID=C.CREDITAPPLICATION_ID
		AND A.AMOUNT_CONFIRM_ID IN
		<iterate open="(" close=")" conjunction=",">
			#receivedRecordId[]#
		</iterate>
	</select>
	<select id="selectUndoFinanceMoney" parameterClass="int" resultClass="financeMoney">
		SELECT F.FINANCE_MONEY_ID financeMoneyId FROM
		RL_FINANCE_MONEY F
		WHERE F.ASSOCIATION_ID =#value# AND
		F.FINANCE_STATUS
		IN ('3','4')
		AND F.HISTORY_FLAG='F'
	</select>
	<update id="updateFinanceMoneyById" parameterClass="financeMoney">
		update
		RL_FINANCE_MONEY
		set HISTORY_FLAG='T',
		REVOCATION_NAME=#revocationName#,
		REVOCATION_TIME=#revocationTime#
		where FINANCE_MONEY_ID = #financeMoneyId#
  </update>
	<update id="updateFinanceMoneyByBizId" parameterClass="financeMoney">
		UPDATE RL_FINANCE_MONEY
		<dynamic prepend="set">
			<isNotEmpty property="financeStatus" prepend="," removeFirstPrepend="true">
				FINANCE_STATUS=#financeStatus#
	   		</isNotEmpty>
			<isNotEmpty property="returnMsg" prepend="," removeFirstPrepend="true">
				RETURN_MSG=#returnMsg#
	   		</isNotEmpty>
			<isNotEmpty property="historyFlag" prepend="," removeFirstPrepend="true">
				HISTORY_FLAG=#historyFlag#
	   		</isNotEmpty>
		</dynamic>
		WHERE BIZ_ID=#bizId#
	</update>
	<select id="selectIsDuaplicatAccount" resultClass="Integer" parameterClass="List">
		SELECT COUNT(DISTINCT accountInfoId) FROM(
		SELECT R.ACCOUNT_INFO_ID accountInfoId
		FROM RL_RECEIVED_RECORD R
		WHERE R.RECEIVED_RECORD_ID IN
		<iterate open="(" close=")" conjunction=",">
			#receivedRecordIdList[]#
		</iterate>
		UNION
		SELECT C.ACCOUNT_INFO_ID accountInfoId
		FROM RL_AMOUNT_CONFIRM A, RL_CREDIT_APPLICATION C
		WHERE A.CREDIT_APPLICATION_ID = C.CREDITAPPLICATION_ID
		AND A.AMOUNT_CONFIRM_ID IN
		<iterate open="(" close=")" conjunction=",">
			#receivedRecordIdList[]#
		</iterate>
		)
	</select>

	<select id="selectBizId" resultMap="financeMoneyResultMap" parameterClass="financeMoney">
		select fm.* from RL_FINANCE_MONEY fm where fm.type = #type# and fm.biz_id = #bizId#
	</select>

	<select id="selectFinanceMoneyByCondition" resultMap="financeMoneyResultMap" parameterClass="financeMoney">
		SELECT FM.*
		FROM RL_FINANCE_MONEY FM
		WHERE FM.HISTORY_FLAG = 'F'
		<isNotEmpty property="associationId" prepend="AND">
			FM.ASSOCIATION_ID = #associationId#
		 </isNotEmpty>
	</select>
	<select id="queryAppointingReseive" resultClass="java.lang.String">
		<![CDATA[
			select fm.biz_id
  			from rl_finance_money fm
 			where fm.type = 'S'
   			and fm.finance_status = '1'
   			and fm.history_flag = 'F'
		]]>
	</select>
	<update id="updateFinanceMoneyStatusAndReturnMSG" parameterClass="java.util.HashMap">
		<![CDATA[
		update rl_finance_money fm
  		set
		]]>
		<![CDATA[
				fm.finance_status =
		]]>
		<isEmpty prepend="" property="financeMoneyResult">
			fm.finance_status		
			</isEmpty>
		<isNotEmpty prepend="" property="financeMoneyResult">
			#financeMoneyResult#
			</isNotEmpty>
			<![CDATA[
				,fm.return_msg =
			]]>
		<isEmpty prepend="" property="returnMSG">
			fm.return_msg
			</isEmpty>
		<isNotEmpty prepend="" property="returnMSG">
			#returnMSG#
			</isNotEmpty>
			<![CDATA[
			 	where fm.biz_id = #bizId#
			]]>
	</update>
	<update id="updateReceivedRecordStatusBybizId" parameterClass="java.util.HashMap">
		<![CDATA[
		update rl_received_record rr 
		set
		]]>
		<![CDATA[
			rr.received_status =
		]]>
		<isEmpty prepend="" property="receivedRecordResult">
			rr.received_status
			</isEmpty>
		<isNotEmpty prepend="" property="receivedRecordResult">
			#receivedRecordResult#
			</isNotEmpty>
			<![CDATA[
			where rr.received_record_id in (select fm.association_id
                                  from rl_finance_money fm
                                 where fm.type = 'S'
                                   and fm.history_flag = 'F'
                                   and fm.biz_id = #bizId#)
			]]>
	</update>

	<select id="queryBizIdListByReceivedRecordIdList" parameterClass="java.util.List" resultClass="java.lang.String">
		select fm.biz_id
		from rl_finance_money fm
		where fm.history_flag = 'F'
		and fm.type = 'S'
		<iterate prepend="and" open="(" close=")" conjunction="or">
			fm.association_id = #receivedRecordIdList[]#
		</iterate>
	</select>
	
	
	<update id="updateHistory" parameterClass="long">
		update rl_finance_money fm set fm.history_flag='T' where 
       fm.association_id=( select g.group_loan_regist_id from rl_group_loan_regist g where g.creditapplication_id=#creditapplicationId# and g.history_flag='F')
	</update>
</sqlMap>